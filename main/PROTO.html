<html>
<head>
<title>The OpenXMLD Proposed Communication Protocol</title>
</head>	
<body>
<pre><xmp>
                 The OpenXMLD Communication Protocol
		 -----------------------------------
Date: May the 7th 2004

Author(s): 
Khalid Al-Kary

Revision: 1.0
-------------------------------------------------------------------------------

Introduction:
-------------
This document describes the way in which an OpenXMLD database server is expected
to behave towards client connections, eventually it describes the way in which 
a client should connect and work with a running OpenXMLD daemon.

Connection Establishment:
-------------------------
Obviously a client can establish a connection with an OpenXMLD daemon by connecting
to one of its listener sockets (specified in the xmld.conf file).

Header Format:
--------------
All the messages sent/received have a <header> message sent before them whose
maximum length is 35 characters  And it has the following format:

message-length <numeric value>
status <boolean>

* message-length: The length of the message following the header.

* status: 0 or 1, failure and success respectively. (always 1 for client-sent
messages)

Note: All messages are NUL-terminated, and all length values mentioned in 
this protocol include the NUL character.

Session Initialization:
-----------------------
After establishing the connection the client must wait for a message that 
has the following form:

<header>

col-sep <character>
col-sep-enc <string>
row-sep <character>
row-sep-enc <string>
down-level <character>
down-level-enc <string>
up-level <character>
up-level-enc <string>

* col-sep: The character which the server is going to use for 
separation of columns.

* col-sep-enc: The string to which an occurence of a column sep-
arator character is to be encoded if it was located inside a column value.

* row-sep: The character which the server is going to use for 
separation of rows.

* row-sep-enc: The string to which an occurence of a row separator character
is to be encoded if it was located inside a column value.

* down-level: The character which the server is going to use to indiciate
incrementing of response deepnes by one.

* down-level-enc: The string to which an occurence of a response deepness
incrementation indiciator is going to be encoded if it was located inside
a column value.

* up-level: The character which the server is going to use to indiciate
decerementing of response deepnes by one.

* up-level-enc: The string to which an occurence of a response deepness
decrementation indiciator is going to be encoded if it was located inside
a column value.

Authentication:
---------------
After reciving the initialization message the client must begin the 
authentication sequence by sending the following message:


<header>

user-name <string>

* user-name: The name of the connecting user.

Note: The additional new line between <header> and the message in this document
doesn't mean an actual additional '\n' but means two separate socket messages,
(i.e two write/send/... system calls for C programms). <header> in the first 
message and the rest in the second one.


After sending the user name, the client must wait until the server sends a 
header with a 0 value of message-length. If status equaled 0 the client should
restart the authentication sequence by sending the user name message again
or send a disconnection message (described later). If status is 1 the client
continues by sending the following message:

<header>

pass <string>

* pass: The password of the connecting user.

The server responds to this message with a message like the one sent after
the user name message, and the client has to respond to it exactly the same
way.

Query:
------
After the authentication sequence the client is free to query the server:

<header>

<query>

The server responds with a record set (to be explained) for queries that pull 
information out of the server:

message-length <whatever>
status 1

col1	;

In case of failure:

message-length <whatever>
status 0

ERR <numeric value>
MSG <error message>

For queries that don't pull data out of the server a status 1 message or a status 0
plus an ERR and MSG message are sent in case of success or failure
respectively.

Disconnection:
--------------
To disconnect from the server, the client sends this message:

<header>

DISCONNECT

Note: Only upper-case DISCONNECT works.

It's safe for the client to shutdown its connected socket after sending the disconnection
message. The server also shutdowns its connected socket once this message is receieved.

Record sets:
------------
Record sets are the way in which the server responds to queries that take data out of
the server. In the OpenXMLD, a record set is a number of NUL-terminated characters whose 
length (including the NUL) is the one mentioned in the record set's message header. 
Record sets are to be processed sequentially, there are only four characters that have 
special meanings--the rest is the data itself. These four special characters are formerly 
explained in the "Session Initialization" section, they are:

* row-sep
* col-sep
* down-level
* up-level

And their encodings (respectively):

* row-sep-enc
* col-sep-enc
* down-level-enc
* up-level-enc

Example:

row-sep is ;
col-sep is % 
down-level is ?
up-level is ~

According to these values, a record set like this one:

?khalid%18%~;

should mean the following (initial level is 0):

? -- Make current level be 1
khalid -- the first column value of the first row is "khalid"
% -- end of first column value (and beginning of second one)
18 -- the second column value of the first row is "18"
% -- end of second column value (and beginning of third one)
~ -- Current level back to 0
; -- end of first row value (and beginning of second one)

if "khalid" originally contained any of the four special 
characters they are encoded to the corresponding *-enc
strings, the client should check for occurences of those
*-enc strings and convert them back to their original values
after extracting column values from the record set.

Note:
NULL column values are indiciated by nothing between two subsequent col-sep
characters (%% -- in the example above).
</xmp></pre>
</body>
</html>
